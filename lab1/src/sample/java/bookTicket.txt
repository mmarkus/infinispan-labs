// First impl of bookTicket, without transactions!

      try {
         Connection connection = cf.createConnection();
         Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
         MessageProducer publisher = session.createProducer(queue);
         connection.start();
         TextMessage message = session.createTextMessage("Book ticket for " + id);
         publisher.send(message);
         tickets.remove(id);
         connection.close();
         session.close();
      } catch (JMSException e) {
         throw new RuntimeException(e);
      }
      
// Second impl of bookTicket, with transactions!
      
try {
   XAConnection connection = null;
   try {
      connection = cf.createXAConnection();
      connection.start();
 
      XASession xaSession = connection.createXASession();
 
      Session session = xaSession.getSession();
      MessageProducer publisher = session.createProducer(queue);
 
      TextMessage message = session.createTextMessage("Book ticket for " + id);
 
      tm.begin();
 
      tm.getTransaction().enlistResource(xaSession.getXAResource());
 
      //following two ops need to be atomic (XA)
      tickets.remove(id);
      publisher.send(message);
 
      tm.commit();
   } finally {
      if (connection != null) connection.close();
   } 
} catch (Throwable e) {
   // don't do this at home :)
   e.printStackTrace(); 
}